<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="RegistroEmpleados.css">
    <meta name="author" content="Astro Code">
    <link rel="shortcut icon" href="Imagenes/iconoWebC.png">  
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;0,900;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">    
    <title>Registro Empleados</title>
</head>
<body>
    <div id="loading">
        <img src="Imagenes/loading.gif">
    </div>

    <div id="ContenedorLoading">
        <div id="ContenedorGeneral">      
            <div id="Contenedor1">
                <button id="Regresar" onclick="location.href = 'MenuConfiguracion.html'"> &#60;</button>
                <h1>Crear Nuevo Empleado/a</h1>


                <div class="Separacion">
                    <div id="SinContrato">
                        <img src="Imagenes/img19.png">
                        <h3>Sin Contrato</h3>
                    </div>
                    <div id="Servicio">
                        <img src="Imagenes/img14.png">
                        <h3>Servicios</h3>                
                    </div>
                    <div id="VentaDirecta">
                        <img src="Imagenes/img13.png">
                        <h3>Venta Directa</h3>                
                    </div>
                </div>
    
                <h2>Cédula</h2>
                <input type="text"  placeholder="Ingrese su número de cédula" id="Cedula" autocomplete="off" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '');">                             
              
              
                <h2>Nombre Completo</h2>
                <input type="text"  placeholder="Ingrese su nombre" id="NombreCompleto" autocomplete="off" oninput="this.value = this.value.replace(/[^A-Z a-zñÑÁÉÍÓÚáéíóú]/g, '');">                             
              
                <h2 id="TSueldo">Sueldo Mensual</h2>
                <input type="text" disabled = false value="0" placeholder="Ingrese el monto a pagar"  id="Sueldo" autocomplete="off" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/^(\d+\.\d*)\..*/g, '$1').replace(/(\.\d\d)\d+/g, '$1');">                             
                              
                <button id="ButtonCrear">Crear nuevo empleado/a</button>
                <button id="ButtonModificar">Modificar perfil</button>
                <button id="ButtonEliminar">Eliminar perfil</button>

       
                
    
            
            
            </div>  
            <div id="Contenedor2">
                <h1 style="text-align: center; color: white; margin-left: 10px; margin-right: 10px;">Lista de Empleados</h1>
                <div id="ListaEmpleadosCreados">
                </div>      
                
                <h1 style="text-align: center; color: white; margin-left: 10px; margin-right: 10px;">Lista de Vendedores</h1>
                <div id="ListaVendedoresCreados">
                </div>      
            </div>  
        </div>
    </div>

  

    <script src="Modulo.js"></script>

</body>
</html>


<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";
    
    const firebaseConfig = {
        apiKey: window.apiKey,
        authDomain: window.authDomain,
        databaseURL: window.databaseURL,
        projectId: window.projectId,
        storageBucket: window.storageBucket,
        messagingSenderId: window.messagingSenderId,
        appId: window.appId,
        measurementId: window.measurementId
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    import {getDatabase,ref,set,child,update,remove,get,push,onValue}
    from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    const db =getDatabase();
    const dbRef = ref(getDatabase());


    // VARIABLES GENERALES
    var Cedula = localStorage.getItem('Cedula');
    var Rol = localStorage.getItem('Rol');
    var Sede = localStorage.getItem('Sede');
    var Periodo = localStorage.getItem('Periodo');
    var FechaInicio = localStorage.getItem('FechaInicio');
    
    // Obtener la fecha actual
    const fechaActual = new Date();
    const dia = fechaActual.getDate();
    const mes = fechaActual.getMonth() + 1;
    const anio = fechaActual.getFullYear();
    var Fecha = `${dia}/${mes}/${anio}`;

    if(Cedula == null){
        alert("El tiempo expiro, inicie sesión nuevamente");
        location.href="index.html";
    }

    if(Fecha != FechaInicio){
        alert("El tiempo expiro, inicie sesión nuevamente");
        location.href="index.html";
    }

    let inactividadTimer;
    function iniciarInactividad() {
        if (inactividadTimer) {
            clearTimeout(inactividadTimer);
        }
        inactividadTimer = setTimeout(function() {
            BaseDeDatos();
            
        }, 5 * 60 * 1000); // 5 minutos en milisegundos
    }
    function reiniciarInactividad() {
        iniciarInactividad();
    }
    document.addEventListener("mousemove", reiniciarInactividad);
    document.addEventListener("keypress", reiniciarInactividad);
    document.addEventListener("touchstart", reiniciarInactividad); // Para dispositivos táctiles
    iniciarInactividad();
    function BaseDeDatos(){            
            get(dbRef).then((snapshot) => {
            if (snapshot.exists()) {
                var Datos = snapshot.val();   
                localStorage.setItem('CopiasDeSeguridad',JSON.stringify(Datos));
                location.href="CopiaDeSeguridad.html";
            }
        
        }).catch((error) => {
            BaseDeDatos();
        });
    }
    



    // PROGRAMACION DEL BLOQUE

    var TipoContrato = "Sin Contrato";

    document.getElementById("SinContrato").onclick = function(e){
        document.getElementById("SinContrato").style.backgroundColor = "#9be2c4";
        document.getElementById("Servicio").style.backgroundColor = "#ffffff";
        document.getElementById("VentaDirecta").style.backgroundColor = "#ffffff"; 
        document.getElementById("TSueldo").innerHTML = "Sueldo Mensual";
        document.getElementById("Sueldo").value = 0;
        document.getElementById("Sueldo").disabled = true;
        TipoContrato = "Sin Contrato";
    }

    document.getElementById("Servicio").onclick = function(e){
        document.getElementById("SinContrato").style.backgroundColor = "#ffffff";
        document.getElementById("Servicio").style.backgroundColor = "#9be2c4";
        document.getElementById("VentaDirecta").style.backgroundColor = "#ffffff";
        document.getElementById("TSueldo").innerHTML = "Sueldo Mensual";
        document.getElementById("Sueldo").disabled = false;
        document.getElementById("Sueldo").value = "";
        TipoContrato = "Servicio";
    }

    document.getElementById("VentaDirecta").onclick = function(e){
        document.getElementById("SinContrato").style.backgroundColor = "#ffffff";
        document.getElementById("Servicio").style.backgroundColor = "#ffffff";
        document.getElementById("VentaDirecta").style.backgroundColor = "#9be2c4";
        document.getElementById("TSueldo").innerHTML = "Pago por venta";
        document.getElementById("Sueldo").disabled = false;
        document.getElementById("Sueldo").value = "";
        TipoContrato = "Venta Directa";
    }

    document.getElementById("ButtonCrear").onclick = function(e){
        var ECedula = document.getElementById("Cedula").value;
        var ENombre = document.getElementById("NombreCompleto").value;
        var ESueldo = document.getElementById("Sueldo").value;

        if(ECedula == ""){
            alert("Ingrese el número de cédula");
            return;
        }

        if(ECedula.length != 10){
            alert("El número de cédula no posee 10 dígitos");
            return;
        }

        if(ENombre == ""){
            alert("Ingrese el nombre del empleado/a");
            return;
        }

        if(ESueldo == ""){
            alert("Ingrese el monto a pagar");
            return;
        }

        if(ESueldo[0] == "."){
            alert("El monto no puede iniciar con un punto");
            return;
        }       
        if(ESueldo[ESueldo.length-1] == "."){
            alert("El monto no puede terminar con un punto");
            return;
        }       

        if(!window.navigator.onLine){
            alert("Compruebe la conexión a internet");
            return;
        } 

        document.getElementById("loading").style.display = "inline";
        document.getElementById("ContenedorLoading").style.display = "none";

        if(TipoContrato == "Venta Directa"){
            LeerVendedores(ECedula,ENombre,ESueldo);
        }
        else{
            LeerEmpleados(ECedula,ENombre,ESueldo);
        }
    }



    function LeerEmpleados(ECedula,ENombre,ESueldo){    
        get(child(dbRef, Periodo+"/"+Sede+"/Empleados/"+ECedula)).then((snapshot) => {
        if (snapshot.exists()) {
            alert("Ya existe un empleado/a con cédula "+ECedula);
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
            return;
        }
        else{
            CrearEmpleado(ECedula,ENombre,ESueldo);
        }    
        })
        .catch((error) => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
            alert("Intente de nuevo");
        });
    }

    function CrearEmpleado(ECedula,ENombre,ESueldo){
        update(ref(db,Periodo+"/"+Sede+"/Empleados/"+ECedula),{
                    Cedula: ECedula, 
                    Nombre: ENombre,
                    TipoContrato: TipoContrato,
                    Sueldo: ESueldo

        })
        .then(()=>{
            location.reload();
            alert("Se a creado correctamente el perfil");
        })
        .catch((error)=>{
            remove(ref(db,Periodo+"/"+Sede+"/Empleados/"+ECedula));  
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";                
            alert("Intente de nuevo");
        });
    }
 

    function LeerVendedores(ECedula,ENombre,ESueldo){    
        get(child(dbRef, Periodo+"/"+Sede+"/Vendedores/"+ECedula)).then((snapshot) => {
        if (snapshot.exists()) {
            alert("Ya existe un vendedor/a con cédula "+ECedula);
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
            return;
        }
        else{
            CrearVendedor(ECedula,ENombre,ESueldo);
        }    
        })
        .catch((error) => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
            alert("Intente de nuevo");
        });
    }

    function CrearVendedor(ECedula,ENombre,ESueldo){
        update(ref(db,Periodo+"/"+Sede+"/Vendedores/"+ECedula),{
                    Cedula: ECedula, 
                    Nombre: ENombre,
                    TipoContrato: TipoContrato,
                    Sueldo: ESueldo

        })
        .then(()=>{
            location.reload();
            alert("Se a creado correctamente el perfil");
        })
        .catch((error)=>{
            remove(ref(db,Periodo+"/"+Sede+"/Vendedores/"+ECedula));  
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";                
            alert("Intente de nuevo");
        });
    }
 

   // LEER LISTA EMPLEADOS
   onValue(child(dbRef, Periodo+"/"+Sede+"/Empleados"), (snapshot) => {
        if (snapshot.exists()) {
            var div = document.getElementById("ListaEmpleadosCreados");
            // Eliminar todos los elementos hijos del div
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }            
            LeerEmpleadosCreados();            
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
        }
        else{
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
        }
    });
    
    function LeerEmpleadosCreados(){
        get(child(dbRef, Periodo+"/"+Sede+"/Empleados")).then((snapshot) => {
            if (snapshot.exists()) {
                const keys = Object.keys(snapshot.val()).reverse();
                keys.forEach((key) => {
                    const hijo = snapshot.val()[key];
                    var ENombre = hijo.Nombre;            
                    var ECedula = hijo.Cedula;
                    var ETipoContrato = hijo.TipoContrato;
                    var ESueldo = hijo.Sueldo;
                    CrearListaEmpleados(ENombre,ECedula,ETipoContrato,ESueldo);
                });    
            }                               
        }).catch((error) => {      
            location.reload();
        });        
    }

    function CrearListaEmpleados(ENombre,ECedula,ETipoContrato,ESueldo){
        var LeerDiv = document.getElementById("ListaEmpleadosCreados");
        var newBloque = document.createElement("div"); 
        newBloque.className = "PerfilesCreados";
        newBloque.onclick = (function() { CargarInformacion(ENombre,ECedula,ETipoContrato,ESueldo); });    
        var newH2 = document.createElement("h2");
        newH2.innerText = ENombre;
        var newP = document.createElement("p");
        newP.innerText = "Cédula: "+ECedula+"\nTipo de Contrato: "+ETipoContrato+"\nSueldo: $"+ESueldo;       
        newBloque.appendChild(newH2); 
        newBloque.appendChild(newP); 
        LeerDiv.appendChild(newBloque);     
    }


    // LEER LISTA VENDEDORES
    onValue(child(dbRef, Periodo+"/"+Sede+"/Vendedores"), (snapshot) => {
        if (snapshot.exists()) {
            var div = document.getElementById("ListaVendedoresCreados");
            // Eliminar todos los elementos hijos del div
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }            
            LeerVendedoresCreados();            
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
        }
        else{
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
        }
    });
    
    function LeerVendedoresCreados(){
        get(child(dbRef, Periodo+"/"+Sede+"/Vendedores")).then((snapshot) => {
            if (snapshot.exists()) {
                const keys = Object.keys(snapshot.val()).reverse();
                keys.forEach((key) => {
                    const hijo = snapshot.val()[key];
                    var ENombre = hijo.Nombre;            
                    var ECedula = hijo.Cedula;
                    var ETipoContrato = hijo.TipoContrato;
                    var ESueldo = hijo.Sueldo;
                    CrearVendedoresEmpleados(ENombre,ECedula,ETipoContrato,ESueldo);
                });    
            }                               
        }).catch((error) => {      
            location.reload();
        });        
    }

    function CrearVendedoresEmpleados(ENombre,ECedula,ETipoContrato,ESueldo){
        var LeerDiv = document.getElementById("ListaVendedoresCreados");
        var newBloque = document.createElement("div"); 
        newBloque.className = "PerfilesCreados";
        newBloque.onclick = (function() { CargarInformacion(ENombre,ECedula,ETipoContrato,ESueldo); });    
        var newH2 = document.createElement("h2");
        newH2.innerText = ENombre;
        var newP = document.createElement("p");
        newP.innerText = "Cédula: "+ECedula+"\nTipo de Contrato: "+ETipoContrato+"\nPago por venta: $"+ESueldo;       
        newBloque.appendChild(newH2); 
        newBloque.appendChild(newP); 
        LeerDiv.appendChild(newBloque);     
    }


    function CargarInformacion(ENombre,ECedula,ETipoContrato,ESueldo){
        document.getElementById("ButtonModificar").style.display = "inline";
        document.getElementById("ButtonEliminar").style.display = "inline";
        document.getElementById("ButtonCrear").style.display = "none";

        document.getElementById("Cedula").value = ECedula;
        document.getElementById("Cedula").disabled = false;
        document.getElementById("NombreCompleto").value = ENombre;
        document.getElementById("Sueldo").value = ESueldo;

        if(ETipoContrato == "Venta Directa"){
            document.getElementById("VentaDirecta").style.backgroundColor = "#9be2c4";
            document.getElementById("SinContrato").style.display = "none";
            document.getElementById("Servicio").style.display = "none";
            document.getElementById("VentaDirecta").style.display = "inline";
            document.getElementById("TSueldo").innerHTML = "Pago por venta";
            document.getElementById("Sueldo").disabled = false;
            TipoContrato = "Venta Directa";
        }
        else{
            document.getElementById("VentaDirecta").style.display = "none";
            document.getElementById("SinContrato").style.display = "inline";
            document.getElementById("Servicio").style.display = "inline";
            document.getElementById("TSueldo").innerHTML = "Sueldo Mensual";
            if(ETipoContrato == "Servicio"){
                document.getElementById("Sueldo").disabled = false;
                document.getElementById("SinContrato").style.backgroundColor = "#ffffff";
                document.getElementById("Servicio").style.backgroundColor = "#9be2c4";
                TipoContrato = "Servicio";
            }
            else{
                document.getElementById("Sueldo").disabled = true;
                document.getElementById("SinContrato").style.backgroundColor = "#9be2c4";
                document.getElementById("Servicio").style.backgroundColor = "#ffffff";
                TipoContrato = "Sin Contrato";
            }
        }
    }


    //MODIFICAR Y ELIMINAR
    document.getElementById("ButtonEliminar").onclick = function(e){
        var ECedula = document.getElementById("Cedula").value;
        if(!window.navigator.onLine){
            alert("Compruebe la conexión a internet");
            return;
        } 

        if(TipoContrato == "Venta Directa"){
            remove(ref(db,Periodo+"/"+Sede+"/Vendedores/"+ECedula));  
        }
        else{
            remove(ref(db,Periodo+"/"+Sede+"/Empleados/"+ECedula));  
        }
        alert("Se ha eliminado correctamente el perfil")
        location.reload();
    }


    document.getElementById("ButtonModificar").onclick = function(e){
        var ECedula = document.getElementById("Cedula").value;
        var ENombre = document.getElementById("NombreCompleto").value;
        var ESueldo = document.getElementById("Sueldo").value;    

        if(ENombre == ""){
            alert("Ingrese el nombre del empleado/a");
            return;
        }

        if(ESueldo == ""){
            alert("Ingrese el monto a pagar");
            return;
        }


        if(ESueldo[0] == "."){
            alert("El monto no puede iniciar con un punto");
            return;
        }       
        if(ESueldo[ESueldo.length-1] == "."){
            alert("El monto no puede terminar con un punto");
            return;
        }     


        if(!window.navigator.onLine){
            alert("Compruebe la conexión a internet");
            return;
        } 

        document.getElementById("loading").style.display = "inline";
        document.getElementById("ContenedorLoading").style.display = "none";

        if(TipoContrato == "Venta Directa"){

            update(ref(db,Periodo+"/"+Sede+"/Vendedores/"+ECedula),{
                    Cedula: ECedula, 
                    Nombre: ENombre,
                    TipoContrato: TipoContrato,
                    Sueldo: ESueldo

            })
            .then(()=>{
                location.reload();
                alert("Se a modificado correctamente el perfil");
            })
            .catch((error)=>{
                document.getElementById("loading").style.display = "none";
                document.getElementById("ContenedorLoading").style.display = "inline";                
                alert("Intente de nuevo");
            });
        }
        else{
            update(ref(db,Periodo+"/"+Sede+"/Empleados/"+ECedula),{
                    Cedula: ECedula, 
                    Nombre: ENombre,
                    TipoContrato: TipoContrato,
                    Sueldo: ESueldo
            })
            .then(()=>{
                location.reload();
                alert("Se a modificado correctamente el perfil");
            })
            .catch((error)=>{
                document.getElementById("loading").style.display = "none";
                document.getElementById("ContenedorLoading").style.display = "inline";                
                alert("Intente de nuevo");
            });
        }


    }



</script>