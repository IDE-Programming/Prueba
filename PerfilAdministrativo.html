<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="PerfilAdministrativo.css">
    <meta name="author" content="Astro Code">
    <link rel="shortcut icon" href="Imagenes/iconoWebC.png">  
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;0,900;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">    
    <title>Perfiles Administrativos</title>
</head>
<body>
    <div id="loading">
        <img src="Imagenes/loading.gif">
    </div>

    <div id="ContenedorLoading">
        <div id="ContenedorGeneral">      
            <div id="Contenedor1">
                <button id="Regresar" onclick="location.href = 'MenuConfiguracion.html'"> &#60;</button>
                <h1>Perfiles<br>Administrativos</h1>
    
                <div class="Separacion">
                    <div>
                        <h2>Período</h2>
                        <input type="text"   id="Periodo" disabled="false"  autocomplete="off" maxlength="10">                  
                    </div>
                    <div>
                        <h2>Sede</h2>
                        <select id="Sede">            
                        </select>    
                    </div>
                </div>
    
                <h2>Nombre Completo</h2>
                <input type="text"  placeholder="Ingrese su nombre" id="NombreCompleto" autocomplete="off" oninput="this.value = this.value.replace(/[^A-Z a-zñÑÁÉÍÓÚáéíóú]/g, '');">                             
                
                <div class="Separacion">
                    <div>
                        <h2>Cédula</h2>
                        <input type="text"  placeholder="Ingrese su número de cédula" id="Cedula"  autocomplete="off" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '');">             
                    </div>
                    <div>
                        <h2>Contraseña</h2>
                        <input type="text"  placeholder="Ingrese su contraseña" id="Clave"  autocomplete="off" oninput="this.value = this.value.replace(/[^A-Za-zñÑÁÉÍÓÚáéíóú0-9-]/g, '');">                             
                    </div>
                </div>
    
                <h2 style="margin-bottom: 10px;">Rol Administrativo</h2>
    
                <div class="Separacion">
                    <div>
                        <div class="radio-container">
                            <label>
                                <input type="radio" class="custom-radio" name="opcion" value="opcion1" id="Radio1">
                                Sistema
                            </label>
                        </div>
                        <div class="radio-container">
                            <label>
                                <input type="radio" class="custom-radio" name="opcion" value="opcion1" id="Radio2">
                                Administrativos
                            </label>
                        </div>
                        <div class="radio-container">
                            <label>
                                <input type="radio" class="custom-radio" name="opcion" value="opcion1" id="Radio3">
                                Recepción
                            </label>
                        </div>                                            
                    </div>
                    <div>
                        <h2>Sistemas</h2>
                        <p>Acceso a todas las funciones del sistema</p>
                        <h2>Administrativos</h2>
                        <p>Acceso a todas las funciones excepto a nuevo período y perfiles administrativos</p>
                        <h2>Recepción</h2>
                        <p>Tiene acceso a estudiantes<br>
                           Tiene acceso a gestión de pagos menos a Pagos empleados y Eliminar Pago<br>
                           Tiene acceso a reportes<br>
                           Tiene acceso a configuración solo a Registro de Unidades Educativas y Crear Nuevos cursos</p>
                    </div>
                </div>
                
                <button id="ButtonCrear">Crear nuevo perfil</button>
                <button id="ButtonModificar">Modificar perfil</button>
                <button id="ButtonEliminar">Eliminar perfil</button>

    
                
    
            
            
            </div>  
            <div id="Contenedor2">
                <h1 style="text-align: center; color: white;">Perfiles Creados</h1>
                <div id="ListaPerfilesCreados">

                </div>               
            </div>  
        </div>
    </div>

  

    <script src="Modulo.js"></script>

</body>
</html>


<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";
    
    const firebaseConfig = {
        apiKey: window.apiKey,
        authDomain: window.authDomain,
        databaseURL: window.databaseURL,
        projectId: window.projectId,
        storageBucket: window.storageBucket,
        messagingSenderId: window.messagingSenderId,
        appId: window.appId,
        measurementId: window.measurementId
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    import {getDatabase,ref,set,child,update,remove,get,push,onValue}
    from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    const db =getDatabase();
    const dbRef = ref(getDatabase());


    // VARIABLES GENERALES
    var Cedula = localStorage.getItem('Cedula');
    var Rol = localStorage.getItem('Rol');
    var Sede = localStorage.getItem('Sede');
    var Periodo = localStorage.getItem('Periodo');
    var FechaInicio = localStorage.getItem('FechaInicio');
    
    // Obtener la fecha actual
    const fechaActual = new Date();
    const dia = fechaActual.getDate();
    const mes = fechaActual.getMonth() + 1;
    const anio = fechaActual.getFullYear();
    var Fecha = `${dia}/${mes}/${anio}`;

    if(Cedula == null){
        alert("El tiempo expiro, inicie sesión nuevamente");
        location.href="index.html";
    }

    if(Fecha != FechaInicio){
        alert("El tiempo expiro, inicie sesión nuevamente");
        location.href="index.html";
    }

    let inactividadTimer;
    function iniciarInactividad() {
        if (inactividadTimer) {
            clearTimeout(inactividadTimer);
        }
        inactividadTimer = setTimeout(function() {
            BaseDeDatos();
            
        }, 5 * 60 * 1000); // 5 minutos en milisegundos
    }
    function reiniciarInactividad() {
        iniciarInactividad();
    }
    document.addEventListener("mousemove", reiniciarInactividad);
    document.addEventListener("keypress", reiniciarInactividad);
    document.addEventListener("touchstart", reiniciarInactividad); // Para dispositivos táctiles
    iniciarInactividad();
    function BaseDeDatos(){            
            get(dbRef).then((snapshot) => {
            if (snapshot.exists()) {
                var Datos = snapshot.val();   
                localStorage.setItem('CopiasDeSeguridad',JSON.stringify(Datos));
                location.href="CopiaDeSeguridad.html";
            }
        
        }).catch((error) => {
            BaseDeDatos();
        });
    }
    



    // PROGRAMACION DEL BLOQUE
    var ListaSedes = window.ListadoDeSedes;
    document.getElementById("Periodo").value = Periodo;

    for(var i = 0; i < ListaSedes.length;i++){
        var combo = document.getElementById("Sede");
        var option = document.createElement('option');
        option.value = ListaSedes[i];
        option.text = ListaSedes[i];
        combo.options.add(option, i);
    }
    document.getElementById("ButtonCrear").onclick = function(e){
        var PASede = document.getElementById("Sede").value;
        var PAPeriodo = document.getElementById("Periodo").value;
        var PANombreCompleto = document.getElementById("NombreCompleto").value;
        var PACedula = document.getElementById("Cedula").value;
        var PAClave = document.getElementById("Clave").value;
        var Radio1 = document.getElementById("Radio1");
        var Radio2 = document.getElementById("Radio2");
        var Radio3 = document.getElementById("Radio3");

        if(PAPeriodo == "Seleccione"){
            alert("Seleccione una período");
            return;
        }
        if(PASede == "Seleccione"){
            alert("Seleccione una sede");
            return;
        }       
        if(PANombreCompleto == ""){
            alert("Ingrese un nombre");
            return;
        }
        if(PACedula == ""){
            alert("Ingrese una cédula");
            return;
        }
        if(PACedula.length != 10){
            alert("La cédula no posee los 10 dígitos");
            return;
        }
        if(PAClave == ""){
            alert("Ingrese una contraseña");
            return;
        }
        if(Radio1.checked == false && Radio2.checked == false && Radio3.checked == false ){
            alert("Seleccione un rol administrativo");
            return; 
        }


        var PARol
        if(Radio1.checked){
            PARol = "Sistemas";
        }
        if(Radio2.checked){
            PARol = "Administrativos";
        }
        if(Radio3.checked){
            PARol = "Recepción";
        }    


        if(!window.navigator.onLine){
            alert("Compruebe la conexión a internet");
            return;
        } 

        document.getElementById("loading").style.display = "inline";
        document.getElementById("ContenedorLoading").style.display = "none";
        Leer(PAPeriodo,PACedula,PAClave,PANombreCompleto,PARol,PASede);
    }

    function Leer(PAPeriodo,PACedula,PAClave,PANombreCompleto,PARol,PASede){    
        get(child(dbRef, "ListaDePeriodos/"+PAPeriodo+"/Empleados/"+PACedula)).then((snapshot) => {
        if (snapshot.exists()) {
            alert("Ya existe un perfil administrativo con cédula "+PACedula);
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
            return;
        }
        else{
            CrearPerfil(PAPeriodo,PACedula,PAClave,PANombreCompleto,PARol,PASede);
        }    
        })
        .catch((error) => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
            alert("Intente de nuevo");
        });
    }

    function CrearPerfil(PAPeriodo,PACedula,PAClave,PANombreCompleto,PARol,PASede){
        update(ref(db,"ListaDePeriodos/"+PAPeriodo+"/Empleados/"+PACedula),{
                    Cedula: PACedula, 
                    Clave: PAClave,
                    Nombre: PANombreCompleto,
                    Rol: PARol,
                    Sedes: PASede                 
        })
        .then(()=>{
            location.reload();
            alert("Se a creado correctamente el perfil");
        })
        .catch((error)=>{
            remove(ref(db,"ListaDePeriodos/"+PAPeriodo+"/Empleados/"+PACedula));  
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";                
            alert("Intente de nuevo");
        });
    }
 


    // LEER LISTA PERFILES
    onValue(child(dbRef, "ListaDePeriodos/"+Periodo+"/Empleados"), (snapshot) => {
        if (snapshot.exists()) {
            var div = document.getElementById("ListaPerfilesCreados");
            // Eliminar todos los elementos hijos del div
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }            
            LeerPerfilesCreados();            
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
        }
        else{
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";
        }
    });
    
    function LeerPerfilesCreados(){
        get(child(dbRef, "ListaDePeriodos/"+Periodo+"/Empleados")).then((snapshot) => {
            if (snapshot.exists()) {
                const keys = Object.keys(snapshot.val()).reverse();
                keys.forEach((key) => {
                    const hijo = snapshot.val()[key];
                    var LPCNombre = hijo.Nombre;
                    var LPCRol = hijo.Rol;
                    var LPCSede = hijo.Sedes;
                    var LPCClave = hijo.Clave;
                    var LPCCedula = hijo.Cedula;

                    CrearPerfiles(LPCNombre,LPCRol,LPCSede,LPCClave,LPCCedula);
                });    
            }                               
        }).catch((error) => {      
            location.reload();
        });        
    }

    function CrearPerfiles(LPCNombre,LPCRol,LPCSede,LPCClave,LPCCedula){
        var LeerDiv = document.getElementById("ListaPerfilesCreados");
        var newBloque = document.createElement("div"); 
        newBloque.className = "PerfilesCreados";
        newBloque.onclick = (function() { CargarInformacion(LPCCedula,LPCClave,LPCNombre,LPCRol,LPCSede); });    
        var newH2 = document.createElement("h2");
        newH2.innerText = LPCNombre;
        var newP = document.createElement("p");
        newP.innerText = "Cédula: "+LPCCedula+"\nContraseña: "+LPCClave+"\nSede: "+LPCSede+"\nRol: "+LPCRol;       
        newBloque.appendChild(newH2); 
        newBloque.appendChild(newP); 
        LeerDiv.appendChild(newBloque);     
    }

    function CargarInformacion(PACedula,PAClave,PANombreCompleto,PARol,PASede){
        document.getElementById("NombreCompleto").value = PANombreCompleto;
        document.getElementById("Cedula").value = PACedula;
        document.getElementById("Cedula").disabled = true;
        document.getElementById("Clave").value = PAClave;
        document.getElementById("Sede").options[ListaSedes.indexOf(PASede)].selected = true;

        if(PARol == "Sistemas"){
            document.getElementById("Radio1").checked = true;
        }
        if(PARol == "Administrativos"){
            document.getElementById("Radio2").checked = true;
        }
        if(PARol == "Recepción"){
            document.getElementById("Radio3").checked = true;
        }
       
        document.getElementById("ButtonCrear").style.display = "none";
        document.getElementById("ButtonModificar").style.display = "inline";
        document.getElementById("ButtonEliminar").style.display = "inline";

    }


    document.getElementById("ButtonModificar").onclick = function(e){
        var PASede = document.getElementById("Sede").value;
        var PAPeriodo = document.getElementById("Periodo").value;
        var PANombreCompleto = document.getElementById("NombreCompleto").value;
        var PACedula = document.getElementById("Cedula").value;
        var PAClave = document.getElementById("Clave").value;
        var Radio1 = document.getElementById("Radio1");
        var Radio2 = document.getElementById("Radio2");
        var Radio3 = document.getElementById("Radio3");

        if(PAPeriodo == "Seleccione"){
            alert("Seleccione una período");
            return;
        }
        if(PASede == "Seleccione"){
            alert("Seleccione una sede");
            return;
        }       
        if(PANombreCompleto == ""){
            alert("Ingrese un nombre");
            return;
        }
       
        if(PAClave == ""){
            alert("Ingrese una contraseña");
            return;
        }
        if(Radio1.checked == false && Radio2.checked == false && Radio3.checked == false ){
            alert("Seleccione un rol administrativo");
            return; 
        }


        var PARol
        if(Radio1.checked){
            PARol = "Sistemas";
        }
        if(Radio2.checked){
            PARol = "Administrativos";
        }
        if(Radio3.checked){
            PARol = "Recepción";
        }    


        if(!window.navigator.onLine){
            alert("Compruebe la conexión a internet");
            return;
        } 


        document.getElementById("loading").style.display = "inline";
        document.getElementById("ContenedorLoading").style.display = "none";

        update(ref(db,"ListaDePeriodos/"+PAPeriodo+"/Empleados/"+PACedula),{
                    Cedula: PACedula, 
                    Clave: PAClave,
                    Nombre: PANombreCompleto,
                    Rol: PARol,
                    Sedes: PASede                 
        })
        .then(()=>{
            location.reload();
            alert("Se a modificado correctamente el perfil");
        })
        .catch((error)=>{           
            document.getElementById("loading").style.display = "none";
            document.getElementById("ContenedorLoading").style.display = "inline";                
            alert("Intente de nuevo");
        });

    }
    
    document.getElementById("ButtonEliminar").onclick = function(e){

        var PAPeriodo = document.getElementById("Periodo").value;
        var PACedula = document.getElementById("Cedula").value;

        if(PACedula == "1723883268"){
            alert("El perfil de administrativo no puede ser eliminado");
            return;
        }

        if(!window.navigator.onLine){
            alert("Compruebe la conexión a internet");
            return;
        } 
        
        remove(ref(db,"ListaDePeriodos/"+PAPeriodo+"/Empleados/"+PACedula));  
        document.getElementById("loading").style.display = "inline";
        document.getElementById("ContenedorLoading").style.display = "none";    
        location.reload();
        alert("Se a eliminado correctamente el perfil");
    }
</script>